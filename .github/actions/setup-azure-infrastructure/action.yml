name: 'Setup Azure Infrastructure'
description: 'Crea o verifica Resource Group y App Service Plan en Azure'

inputs:
  resource-group-name:
    description: 'Nombre del Resource Group'
    required: true
  app-service-plan-name:
    description: 'Nombre del App Service Plan'
    required: true
  azure-location:
    description: 'Regi√≥n de Azure'
    required: true
  azure-sku:
    description: 'SKU del App Service Plan'
    required: true
  azure-subscription-id:
    description: 'Azure Subscription ID'
    required: true
  environment-name:
    description: 'Nombre del environment (para tags)'
    required: false
    default: 'preview'

outputs:
  resource-group:
    description: 'Nombre del Resource Group'
    value: ${{ steps.config.outputs.resource_group }}
  app-service-plan:
    description: 'Nombre del App Service Plan'
    value: ${{ steps.config.outputs.app_service_plan }}
  azure-location:
    description: 'Regi√≥n de Azure utilizada'
    value: ${{ steps.config.outputs.azure_location }}
  azure-sku:
    description: 'SKU del App Service Plan'
    value: ${{ steps.config.outputs.azure_sku }}

runs:
  using: 'composite'
  steps:
    - name: Configure outputs
      id: config
      shell: bash
      run: |
        echo "resource_group=${{ inputs.resource-group-name }}" >> $GITHUB_OUTPUT
        echo "app_service_plan=${{ inputs.app-service-plan-name }}" >> $GITHUB_OUTPUT
        echo "azure_location=${{ inputs.azure-location }}" >> $GITHUB_OUTPUT
        echo "azure_sku=${{ inputs.azure-sku }}" >> $GITHUB_OUTPUT

        echo "üìã Configuraci√≥n de infraestructura:"
        echo "  Resource Group: ${{ inputs.resource-group-name }}"
        echo "  App Service Plan: ${{ inputs.app-service-plan-name }}"
        echo "  Location: ${{ inputs.azure-location }}"
        echo "  SKU: ${{ inputs.azure-sku }}"

    - name: Create or verify Resource Group
      shell: bash
      run: |
        RESOURCE_GROUP="${{ inputs.resource-group-name }}"
        LOCATION="${{ inputs.azure-location }}"

        echo "üîç Verificando Resource Group '${RESOURCE_GROUP}'..."

        if az group show --name "${RESOURCE_GROUP}" --subscription "${{ inputs.azure-subscription-id }}" &>/dev/null; then
          RG_LOCATION=$(az group show \
            --name "${RESOURCE_GROUP}" \
            --subscription "${{ inputs.azure-subscription-id }}" \
            --query location -o tsv)

          echo "‚úÖ Resource Group ya existe"
          echo "üìç Ubicaci√≥n: ${RG_LOCATION}"

          # Verificar si la ubicaci√≥n coincide
          RG_NORMALIZED=$(echo "$RG_LOCATION" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
          EXPECTED_NORMALIZED=$(echo "$LOCATION" | tr '[:upper:]' '[:lower:]' | tr -d ' ')

          if [ "$RG_NORMALIZED" != "$EXPECTED_NORMALIZED" ]; then
            echo ""
            echo "‚ö†Ô∏è  NOTA: Resource Group est√° en regi√≥n diferente"
            echo "   Resource Group: ${RG_LOCATION}"
            echo "   Esperado: ${LOCATION}"
            echo "   (Los recursos se crear√°n en ${LOCATION})"
          fi
        else
          echo "üì¶ Creando Resource Group '${RESOURCE_GROUP}' en ${LOCATION}..."
          az group create \
            --name "${RESOURCE_GROUP}" \
            --location "${LOCATION}" \
            --subscription "${{ inputs.azure-subscription-id }}" \
            --tags environment=${{ inputs.environment-name }} managed-by=github-actions

          echo "‚úÖ Resource Group creado"
        fi

    - name: Create or verify App Service Plan
      shell: bash
      run: |
        RESOURCE_GROUP="${{ inputs.resource-group-name }}"
        APP_SERVICE_PLAN="${{ inputs.app-service-plan-name }}"
        LOCATION="${{ inputs.azure-location }}"
        SKU="${{ inputs.azure-sku }}"

        echo "üîç Verificando App Service Plan '${APP_SERVICE_PLAN}'..."

        if az appservice plan show \
          --name "${APP_SERVICE_PLAN}" \
          --resource-group "${RESOURCE_GROUP}" \
          --subscription "${{ inputs.azure-subscription-id }}" &>/dev/null; then

          CURRENT_LOCATION=$(az appservice plan show \
            --name "${APP_SERVICE_PLAN}" \
            --resource-group "${RESOURCE_GROUP}" \
            --subscription "${{ inputs.azure-subscription-id }}" \
            --query location -o tsv)

          CURRENT_SKU=$(az appservice plan show \
            --name "${APP_SERVICE_PLAN}" \
            --resource-group "${RESOURCE_GROUP}" \
            --subscription "${{ inputs.azure-subscription-id }}" \
            --query sku.name -o tsv)

          echo "‚úÖ App Service Plan ya existe"
          echo "üìç Ubicaci√≥n: ${CURRENT_LOCATION}"
          echo "üí∞ SKU: ${CURRENT_SKU}"

          # Verificar regi√≥n
          CURRENT_NORMALIZED=$(echo "$CURRENT_LOCATION" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
          EXPECTED_NORMALIZED=$(echo "$LOCATION" | tr '[:upper:]' '[:lower:]' | tr -d ' ')

          if [ "$CURRENT_NORMALIZED" != "$EXPECTED_NORMALIZED" ]; then
            echo ""
            echo "‚ö†Ô∏è  WARNING: App Service Plan est√° en regi√≥n diferente"
            echo "   Actual: ${CURRENT_LOCATION}"
            echo "   Esperado: ${LOCATION}"
            echo ""
            echo "üóëÔ∏è  Eliminando plan para recrearlo en regi√≥n correcta..."

            az appservice plan delete \
              --name "${APP_SERVICE_PLAN}" \
              --resource-group "${RESOURCE_GROUP}" \
              --subscription "${{ inputs.azure-subscription-id }}" \
              --yes

            echo "üì¶ Recreando App Service Plan en ${LOCATION}..."
            if ! az appservice plan create \
              --resource-group "${RESOURCE_GROUP}" \
              --name "${APP_SERVICE_PLAN}" \
              --is-linux \
              --sku "${SKU}" \
              --location "${LOCATION}" \
              --subscription "${{ inputs.azure-subscription-id }}" \
              --tags environment=${{ inputs.environment-name }} managed-by=github-actions; then
              echo "‚ùå ERROR: No se pudo crear el App Service Plan"
              exit 1
            fi
            echo "‚úÖ App Service Plan recreado"
          fi
        else
          echo "üì¶ Creando App Service Plan '${APP_SERVICE_PLAN}' con SKU ${SKU}..."

          if ! az appservice plan create \
            --resource-group "${RESOURCE_GROUP}" \
            --name "${APP_SERVICE_PLAN}" \
            --is-linux \
            --sku "${SKU}" \
            --location "${LOCATION}" \
            --subscription "${{ inputs.azure-subscription-id }}" \
            --tags environment=${{ inputs.environment-name }} managed-by=github-actions; then

            echo "‚ùå ERROR: No se pudo crear el App Service Plan"
            echo ""
            echo "üí° Posibles soluciones:"
            echo "   1. Verificar cuota para SKU ${SKU} en ${LOCATION}"
            echo "   2. Cambiar AZURE_SKU (F1, S1, P1v2)"
            echo "   3. Usar un App Service Plan existente"
            exit 1
          fi

          echo "‚úÖ App Service Plan creado"
        fi

    - name: Verify infrastructure
      shell: bash
      run: |
        RESOURCE_GROUP="${{ inputs.resource-group-name }}"
        APP_SERVICE_PLAN="${{ inputs.app-service-plan-name }}"

        echo "üîç Verificaci√≥n final..."

        if ! az group show --name "${RESOURCE_GROUP}" --subscription "${{ inputs.azure-subscription-id }}" &>/dev/null; then
          echo "‚ùå ERROR: Resource Group no existe"
          exit 1
        fi

        if ! az appservice plan show \
          --name "${APP_SERVICE_PLAN}" \
          --resource-group "${RESOURCE_GROUP}" \
          --subscription "${{ inputs.azure-subscription-id }}" &>/dev/null; then
          echo "‚ùå ERROR: App Service Plan no existe"
          exit 1
        fi

        echo "‚úÖ Infraestructura verificada"
