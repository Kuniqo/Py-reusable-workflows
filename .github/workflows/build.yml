name: Build Packages (Reusable - Python)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: "3.12"
    outputs:
      build_outcome:
        description: "Resultado del build de Python"
        value: ${{ jobs.python-build.outputs.build_outcome }}
      package_path:
        description: "Ruta de los paquetes Python construidos"
        value: ${{ jobs.python-build.outputs.package_path }}

jobs:
  python-build:
    name: Build Python Package
    runs-on: ubuntu-latest
    outputs:
      build_outcome: ${{ steps.build.outcome }}
      package_path: ${{ steps.build.outputs.package_path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: "pip"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Build Python package
        id: build
        run: |
          echo "Construyendo paquete Python..."
          python -m pip install --upgrade build

          set +e
          python -m build > build-output.txt 2>&1
          BUILD_EXIT=$?
          set -e

          cat build-output.txt

          if [ $BUILD_EXIT -eq 0 ]; then
            echo "Paquete construido exitosamente"
            ls -lh dist/

            # Guardar path para siguiente job
            echo "package_path=dist/" >> $GITHUB_OUTPUT

            # Informacion sobre los paquetes generados
            WHL_FILE=$(ls dist/*.whl | head -1 || echo "")
            TAR_FILE=$(ls dist/*.tar.gz | head -1 || echo "")

            if [ -n "$WHL_FILE" ]; then
              WHL_SIZE=$(du -h "$WHL_FILE" | cut -f1)
              echo "Wheel: $(basename $WHL_FILE) ($WHL_SIZE)"
            fi

            if [ -n "$TAR_FILE" ]; then
              TAR_SIZE=$(du -h "$TAR_FILE" | cut -f1)
              echo "Tarball: $(basename $TAR_FILE) ($TAR_SIZE)"
            fi

            exit 0
          else
            echo "::error::Build fallo"
            exit 1
          fi

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: python-build-logs-${{ github.run_id }}
          path: build-output.txt
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload build artifacts for testing
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: python-build-artifacts-${{ github.run_id }}
          path: dist/
          retention-days: 1
          if-no-files-found: warn
