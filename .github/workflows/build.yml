name: Build Packages (Reusable - Universal)

on:
  workflow_call:
    inputs:
      language:
        required: true
        type: string
        description: "Lenguaje a construir: 'python', 'javascript', o 'typescript'"
      python-version:
        required: false
        type: string
        default: "3.12"
      node-version:
        required: false
        type: string
        default: "20"
      # Variables p√∫blicas como inputs
      BASE_URL:
        required: false
        type: string
        description: "Base URL for the application (build time)"
      NEXTAUTH_URL:
        required: false
        type: string
        description: "NextAuth base URL"
      NEXT_PUBLIC_BASE_URL:
        required: false
        type: string
        description: "Public base URL for Next.js"
      SMTP_HOST:
        required: false
        type: string
        description: "SMTP server host"
      SMTP_PORT:
        required: false
        type: string
        description: "SMTP server port"
      SMTP_USER:
        required: false
        type: string
        description: "SMTP username"
    secrets:
      DATABASE_URL:
        required: false
        description: "Database connection URL"
      NEXTAUTH_SECRET:
        required: false
        description: "NextAuth secret key"
      AUTH_SECRET:
        required: false
        description: "Auth secret key"
      SMTP_PASS:
        required: false
        description: "SMTP password"
    outputs:
      # Python outputs
      python_build_outcome:
        description: "Resultado del build de Python"
        value: ${{ jobs.python-build.outputs.build_outcome }}
      python_package_path:
        description: "Ruta de los paquetes Python construidos"
        value: ${{ jobs.python-build.outputs.package_path }}
      # JS/TS outputs
      js_ts_build_outcome:
        description: "Resultado del build de JS/TS"
        value: ${{ jobs.js-ts-build.outputs.build_outcome }}
      js_ts_build_size:
        description: "Tama√±o del build de JS/TS en MB"
        value: ${{ jobs.js-ts-build.outputs.build_size }}

permissions:
  contents: read

jobs:
  # ==============================
  #  PYTHON BUILD
  # ==============================
  python-build:
    name: Build Python Package
    runs-on: ubuntu-latest
    if: inputs.language == 'python'
    outputs:
      build_outcome: ${{ steps.build.outcome }}
      package_path: ${{ steps.build.outputs.package_path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: "pip"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Build Python package
        id: build
        run: |
          echo "üì¶ Construyendo paquete Python..."
          python -m pip install --upgrade build

          set +e
          python -m build > build-output.txt 2>&1
          BUILD_EXIT=$?
          set -e

          cat build-output.txt

          if [ $BUILD_EXIT -eq 0 ]; then
            echo "‚úÖ Paquete construido exitosamente"
            ls -lh dist/

            # Guardar path para siguiente job
            echo "package_path=dist/" >> $GITHUB_OUTPUT

            # Informaci√≥n sobre los paquetes generados
            WHL_FILE=$(ls dist/*.whl | head -1 || echo "")
            TAR_FILE=$(ls dist/*.tar.gz | head -1 || echo "")

            if [ -n "$WHL_FILE" ]; then
              WHL_SIZE=$(du -h "$WHL_FILE" | cut -f1)
              echo "üì¶ Wheel: $(basename $WHL_FILE) ($WHL_SIZE)"
            fi

            if [ -n "$TAR_FILE" ]; then
              TAR_SIZE=$(du -h "$TAR_FILE" | cut -f1)
              echo "üì¶ Tarball: $(basename $TAR_FILE) ($TAR_SIZE)"
            fi

            exit 0
          else
            echo "::error::‚ùå Build fall√≥"
            exit 1
          fi

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: python-build-logs-${{ github.run_id }}
          path: build-output.txt
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload build artifacts for testing
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: python-build-artifacts-${{ github.run_id }}
          path: dist/
          retention-days: 1
          if-no-files-found: warn

  # ==============================
  #  JAVASCRIPT/TYPESCRIPT BUILD
  # ==============================
  js-ts-build:
    name: Build JavaScript/TypeScript
    runs-on: ubuntu-latest
    if: inputs.language == 'javascript' || inputs.language == 'typescript'
    env:
      BASE_URL: ${{ inputs.BASE_URL }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NEXTAUTH_URL: ${{ inputs.NEXTAUTH_URL }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
      NEXT_PUBLIC_BASE_URL: ${{ inputs.NEXT_PUBLIC_BASE_URL }}
      SMTP_HOST: ${{ inputs.SMTP_HOST }}
      SMTP_PORT: ${{ inputs.SMTP_PORT }}
      SMTP_USER: ${{ inputs.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      NEXT_TELEMETRY_DISABLED: 1
      SKIP_ENV_VALIDATION: true
    outputs:
      build_outcome: ${{ steps.build.outcome }}
      build_size: ${{ steps.build.outputs.build_size }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      - name: Install Node dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build JS/TS project
        id: build
        run: |
          # Limpiar builds anteriores
          [ -d ".next" ] && rm -rf .next
          [ -d "dist" ] && rm -rf dist
          [ -d "build" ] && rm -rf build

          echo "üì¶ Construyendo proyecto JS/TS..."

          # Intentar build:ci primero, si no existe usar build
          if grep -q '"build:ci"' package.json 2>/dev/null; then
            echo "‚úÖ Ejecutando npm run build:ci"
            BUILD_CMD="npm run build:ci"
          else
            echo "‚ö†Ô∏è Script build:ci no encontrado, usando npm run build"
            BUILD_CMD="npm run build"
          fi

          set +e
          $BUILD_CMD > build-output.txt 2>&1
          BUILD_EXIT=$?
          set -e

          cat build-output.txt

          if [ $BUILD_EXIT -eq 0 ]; then
            echo "‚úÖ Build exitoso"

            # Limpiar cache de Next.js si existe (no es necesario para deployment)
            if [ -d ".next/cache" ]; then
              CACHE_SIZE=$(du -sm .next/cache 2>/dev/null | cut -f1 || echo "0")
              echo "üßπ Eliminando cache de webpack (.next/cache): ${CACHE_SIZE}MB"
              rm -rf .next/cache
            fi

            # Detectar directorio de build y calcular tama√±o
            BUILD_SIZE_MB=0
            BUILD_DIR_FOUND="false"

            if [ -d ".next" ]; then
              BUILD_SIZE_MB=$(du -sm .next 2>/dev/null | cut -f1 || echo "0")
              echo "üìä Build size (.next): ${BUILD_SIZE_MB}MB"
              BUILD_DIR_FOUND="true"
            elif [ -d "out" ]; then
              BUILD_SIZE_MB=$(du -sm out 2>/dev/null | cut -f1 || echo "0")
              echo "üìä Build size (out): ${BUILD_SIZE_MB}MB"
              BUILD_DIR_FOUND="true"
            elif [ -d "dist" ]; then
              BUILD_SIZE_MB=$(du -sm dist 2>/dev/null | cut -f1 || echo "0")
              echo "üìä Build size (dist): ${BUILD_SIZE_MB}MB"
              BUILD_DIR_FOUND="true"
            elif [ -d "build" ]; then
              BUILD_SIZE_MB=$(du -sm build 2>/dev/null | cut -f1 || echo "0")
              echo "üìä Build size (build): ${BUILD_SIZE_MB}MB"
              BUILD_DIR_FOUND="true"
            fi

            echo "build_size=$BUILD_SIZE_MB" >> $GITHUB_OUTPUT

            # Warning si no se gener√≥ ning√∫n directorio de build
            if [ "$BUILD_DIR_FOUND" == "false" ]; then
              echo "::warning::‚ö†Ô∏è El build no gener√≥ ning√∫n directorio (.next/, dist/, build/)."
              echo "::warning::Listando directorios generados:"
              ls -la | grep '^d' | grep -v 'node_modules' | grep -v '.git' || true
              echo "::warning::Si tu build genera un directorio diferente (ej: out/, public/, lib/), agr√©galo al workflow en .github/workflows/build.yml l√≠nea 206"
            fi

            # Warning si el build es muy grande
            if [ "$BUILD_SIZE_MB" -gt 300 ]; then
              echo "::warning::Build muy grande ($BUILD_SIZE_MB MB). Considera optimizar."
            fi

            exit 0
          else
            echo "::error::‚ùå Build fall√≥"
            exit 1
          fi

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: js-ts-build-logs-${{ github.run_id }}
          path: build-output.txt
          retention-days: 7
          if-no-files-found: ignore

      - name: Create tarball of build artifacts
        if: success()
        run: |
          echo "üì¶ Creando tarball de los artifacts del build..."
          if [ -d ".next" ]; then
            # Solo incluir .next (el build de Next.js)
            # Prisma se manejar√° directamente en el Dockerfile
            tar -czf build-artifacts.tar.gz .next
            echo "‚úÖ Tarball creado: $(ls -lh build-artifacts.tar.gz | awk '{print $5}')"
          else
            echo "‚ùå No se encontr√≥ directorio .next para comprimir"
            exit 1
          fi

      - name: Upload build artifacts for testing
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: js-ts-build-artifacts-${{ github.run_id }}
          path: build-artifacts.tar.gz
          retention-days: 1
          if-no-files-found: warn
