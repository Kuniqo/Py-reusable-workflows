name: Deploy to Staging (Azure - Python)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: "3.12"
      docker-registry:
        required: false
        type: string
        default: "ghcr.io"
      docker-image-name:
        required: true
        type: string
        description: "Docker image name (e.g., org/app-name)"
      azure-webapp-name:
        required: true
        type: string
        description: "Azure Web App name"
      environment:
        required: false
        type: string
        default: "staging"
        description: "Target environment (staging, development, production)"
    secrets:
      CR_PAT:
        required: true
        description: "Personal Access Token for GitHub Container Registry"
      AZURE_CREDENTIALS:
        required: true
        description: "Azure Service Principal credentials (JSON)"

permissions:
  contents: read
  packages: write

jobs:
  # ==============================
  #  JOB 1: BUILD
  # ==============================
  build:
    name: Build Application
    uses: ./.github/workflows/build.yml
    with:
      python-version: ${{ inputs.python-version }}

  # ==============================
  #  JOB 2: BUILD & PUSH DOCKER IMAGE
  # ==============================
  build-docker-image:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.docker-build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-build-artifacts-${{ github.run_id }}
          path: ./dist

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker-registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.docker-registry }}/${{ github.repository }}/${{ inputs.docker-image-name }}
          tags: |
            # SHA con formato corto para Azure
            type=sha,format=short,prefix=
            # Branch name
            type=ref,event=branch
            # PR number
            type=ref,event=pr
            # Semantic versioning
            type=semver,pattern={{version}}
            # Latest para default branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: docker-build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Image build summary
        run: |
          echo "## Docker Image Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Imagen construida y pusheada exitosamente**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          REGISTRY="${{ inputs.docker-registry }}"
          IMAGE_NAME="${{ github.repository }}/${{ inputs.docker-image-name }}"
          FIRST_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)

          # Generar URL del package
          if [[ "$REGISTRY" == "ghcr.io" ]]; then
            ORG=$(echo "${{ github.repository }}" | cut -d'/' -f1)
            REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            PACKAGE_URL="https://github.com/${ORG}/packages/container/package/${REPO}%2F${{ inputs.docker-image-name }}"
          else
            PACKAGE_URL="${REGISTRY}/${IMAGE_NAME}"
          fi

          echo "### Package Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${REGISTRY}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${IMAGE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Package URL**: ${PACKAGE_URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Tags Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Image Digest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.docker-build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # ==============================
  #  JOB 3: DEPLOY TO AZURE
  # ==============================
  deploy-to-azure:
    name: Deploy to Azure Web App
    runs-on: ubuntu-latest
    needs: build-docker-image
    if: needs.build-docker-image.result == 'success'
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ inputs.azure-webapp-name }}.azurewebsites.net

    steps:
      - name: Login via Azure CLI
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to GHCR for Azure
        uses: azure/docker-login@v1
        with:
          login-server: ${{ inputs.docker-registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: Get image tag
        id: image-info
        run: |
          FULL_TAG=$(echo "${{ needs.build-docker-image.outputs.image-tag }}" | head -n1)
          echo "full_tag=${FULL_TAG}" >> $GITHUB_OUTPUT
          echo "Using image: ${FULL_TAG}"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ inputs.azure-webapp-name }}
          images: ${{ steps.image-info.outputs.full_tag }}

      - name: Azure logout
        if: always()
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az logout
            az cache purge
            az account clear

      - name: Deployment summary
        if: always()
        run: |
          echo "## Azure Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment exitoso a Azure Web App**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Web App**: \`${{ inputs.azure-webapp-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ steps.image-info.outputs.full_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ inputs.azure-webapp-name }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Visit App](https://${{ inputs.azure-webapp-name }}.azurewebsites.net)" >> $GITHUB_STEP_SUMMARY
          echo "- [Azure Portal](https://portal.azure.com)" >> $GITHUB_STEP_SUMMARY

  # ==============================
  #  JOB 4: DEPLOYMENT SUMMARY
  # ==============================
  deployment-summary:
    name: Final Deployment Summary
    runs-on: ubuntu-latest
    needs: [build, build-docker-image, deploy-to-azure]
    if: always()

    steps:
      - name: Generate final summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Lenguaje:** Python" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build Status
          BUILD_STATUS="${{ needs.build.result }}"
          if [ "$BUILD_STATUS" == "success" ]; then
            echo "- Build: Exitoso" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Build: Fallo ($BUILD_STATUS)" >> $GITHUB_STEP_SUMMARY
          fi

          # Docker Build Status
          DOCKER_STATUS="${{ needs.build-docker-image.result }}"
          if [ "$DOCKER_STATUS" == "success" ]; then
            echo "- Docker Build: Imagen construida exitosamente" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Docker Build: Fallo ($DOCKER_STATUS)" >> $GITHUB_STEP_SUMMARY
          fi

          # Deployment Status
          DEPLOY_STATUS="${{ needs.deploy-to-azure.result }}"
          if [ "$DEPLOY_STATUS" == "success" ]; then
            echo "- Azure Deployment: Exitoso" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Deployment Completado" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tu aplicacion esta ahora en vivo en:" >> $GITHUB_STEP_SUMMARY
            echo "**https://${{ inputs.azure-webapp-name }}.azurewebsites.net**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Azure Deployment: Fallo ($DEPLOY_STATUS)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
