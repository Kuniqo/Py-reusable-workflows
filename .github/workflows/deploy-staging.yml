name: Deploy to Staging (Azure)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: "3.12"
      node-version:
        required: false
        type: string
        default: "20"
      docker-registry:
        required: false
        type: string
        default: "ghcr.io"
      docker-image-name:
        required: true
        type: string
        description: "Docker image name (e.g., org/app-name)"
      azure-webapp-name:
        required: true
        type: string
        description: "Azure Web App name"
      environment:
        required: false
        type: string
        default: "staging"
        description: "Target environment (staging, development, production)"
    secrets:
      CR_PAT:
        required: true
        description: "Personal Access Token for GitHub Container Registry"
      AZURE_CREDENTIALS:
        required: true
        description: "Azure Service Principal credentials (JSON)"
      DATABASE_URL:
        required: false
      NEXTAUTH_URL:
        required: false
      NEXTAUTH_SECRET:
        required: false
      AUTH_SECRET:
        required: false
      NEXT_PUBLIC_BASE_URL:
        required: false

permissions:
  contents: read
  packages: write

jobs:
  # ==============================
  #  JOB 1: DETECCIÃ“N DE LENGUAJE
  # ==============================
  detect-language:
    name: Detectar Lenguaje
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.detect.outputs.lang }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        run: |
          if [ -f "pyproject.toml" ]; then
            echo "lang=python" >> $GITHUB_OUTPUT
            echo "ðŸ Proyecto Python detectado"
          elif [ -f "package.json" ]; then
            if grep -q '"typescript"' package.json || [ -f "tsconfig.json" ]; then
              echo "lang=typescript" >> $GITHUB_OUTPUT
              echo "ðŸ“˜ Proyecto TypeScript detectado"
            else
              echo "lang=javascript" >> $GITHUB_OUTPUT
              echo "ðŸ“— Proyecto JavaScript detectado"
            fi
          else
            echo "lang=unknown" >> $GITHUB_OUTPUT
            echo "â“ Lenguaje no detectado"
            exit 1
          fi

  # ==============================
  #  JOB 2: BUILD (UNIVERSAL)
  # ==============================
  build:
    name: Build Application
    needs: detect-language
    if: needs.detect-language.outputs.language != 'unknown'
    uses: ./.github/workflows/build.yml
    with:
      language: ${{ needs.detect-language.outputs.language }}
      python-version: ${{ inputs.python-version }}
      node-version: ${{ inputs.node-version }}
    secrets:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
      NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}

  # ==============================
  #  JOB 3: BUILD & PUSH DOCKER IMAGE
  # ==============================
  build-docker-image:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [detect-language, build]
    if: needs.build.result == 'success'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.docker-build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.run_id }}
          path: ./artifacts

      - name: Extract build artifacts
        run: |
          echo "ðŸ“¦ Extrayendo build artifacts..."

          # Para JS/TS projects
          if [ -f "./artifacts/build-artifacts.tar.gz" ]; then
            echo "âœ… Encontrado build-artifacts.tar.gz (JS/TS)"
            cd artifacts
            tar -xzf build-artifacts.tar.gz
            rm build-artifacts.tar.gz
            cd ..

            # Mover artifacts al lugar correcto
            if [ -d "./artifacts/.next" ]; then
              echo "ðŸ“ Moviendo .next/ al directorio raÃ­z..."
              mv ./artifacts/.next ./.next
            elif [ -d "./artifacts/dist" ]; then
              echo "ðŸ“ Moviendo dist/ al directorio raÃ­z..."
              mv ./artifacts/dist ./dist
            elif [ -d "./artifacts/build" ]; then
              echo "ðŸ“ Moviendo build/ al directorio raÃ­z..."
              mv ./artifacts/build ./build
            fi
          # Para Python projects
          elif [ -d "./artifacts/dist" ]; then
            echo "âœ… Encontrado dist/ (Python)"
            mv ./artifacts/dist ./dist
          else
            echo "âš ï¸ No se encontrÃ³ estructura de build conocida"
            ls -la ./artifacts/
          fi

          echo "âœ… Build artifacts extraÃ­dos"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker-registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.docker-registry }}/${{ github.repository }}/${{ inputs.docker-image-name }}
          tags: |
            # SHA con formato corto para Azure
            type=sha,format=short,prefix=
            # Branch name
            type=ref,event=branch
            # PR number
            type=ref,event=pr
            # Semantic versioning
            type=semver,pattern={{version}}
            # Latest para default branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: docker-build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Image build summary
        run: |
          echo "## ðŸ³ Docker Image Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Imagen construida y pusheada exitosamente**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          REGISTRY="${{ inputs.docker-registry }}"
          IMAGE_NAME="${{ github.repository }}/${{ inputs.docker-image-name }}"
          FIRST_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)

          # Generar URL del package
          if [[ "$REGISTRY" == "ghcr.io" ]]; then
            ORG=$(echo "${{ github.repository }}" | cut -d'/' -f1)
            REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            PACKAGE_URL="https://github.com/${ORG}/packages/container/package/${REPO}%2F${{ inputs.docker-image-name }}"
          else
            PACKAGE_URL="${REGISTRY}/${IMAGE_NAME}"
          fi

          echo "### ðŸ“¦ Package Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${REGISTRY}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${IMAGE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Package URL**: ${PACKAGE_URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ·ï¸ Tags Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“Š Image Digest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.docker-build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # ==============================
  #  JOB 4: DEPLOY TO AZURE
  # ==============================
  deploy-to-azure:
    name: Deploy to Azure Web App
    runs-on: ubuntu-latest
    needs: [detect-language, build-docker-image]
    if: needs.build-docker-image.result == 'success'
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ inputs.azure-webapp-name }}.azurewebsites.net

    steps:
      - name: Login via Azure CLI
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to GHCR for Azure
        uses: azure/docker-login@v1
        with:
          login-server: ${{ inputs.docker-registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: Get image tag
        id: image-info
        run: |
          FULL_TAG=$(echo "${{ needs.build-docker-image.outputs.image-tag }}" | head -n1)
          echo "full_tag=${FULL_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Using image: ${FULL_TAG}"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ inputs.azure-webapp-name }}
          images: ${{ steps.image-info.outputs.full_tag }}

      - name: Azure logout
        if: always()
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az logout
            az cache purge
            az account clear

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Azure Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment exitoso a Azure Web App**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Web App**: \`${{ inputs.azure-webapp-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ steps.image-info.outputs.full_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ inputs.azure-webapp-name }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸŒ Visit App](https://${{ inputs.azure-webapp-name }}.azurewebsites.net)" >> $GITHUB_STEP_SUMMARY
          echo "- [âš™ï¸ Azure Portal](https://portal.azure.com)" >> $GITHUB_STEP_SUMMARY

  # ==============================
  #  JOB 5: DEPLOYMENT SUMMARY
  # ==============================
  deployment-summary:
    name: Final Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-language, build, build-docker-image, deploy-to-azure]
    if: always()

    steps:
      - name: Generate final summary
        run: |
          echo "## ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Language Detection
          LANGUAGE="${{ needs.detect-language.outputs.language }}"
          echo "**Lenguaje detectado:** $LANGUAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build Status
          BUILD_STATUS="${{ needs.build.result }}"
          if [ "$BUILD_STATUS" == "success" ]; then
            echo "- âœ… **Build**: Exitoso" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Build**: FallÃ³ ($BUILD_STATUS)" >> $GITHUB_STEP_SUMMARY
          fi

          # Docker Build Status
          DOCKER_STATUS="${{ needs.build-docker-image.result }}"
          if [ "$DOCKER_STATUS" == "success" ]; then
            echo "- âœ… **Docker Build**: Imagen construida exitosamente" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Docker Build**: FallÃ³ ($DOCKER_STATUS)" >> $GITHUB_STEP_SUMMARY
          fi

          # Deployment Status
          DEPLOY_STATUS="${{ needs.deploy-to-azure.result }}"
          if [ "$DEPLOY_STATUS" == "success" ]; then
            echo "- âœ… **Azure Deployment**: Exitoso" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ‰ Deployment Completado" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tu aplicaciÃ³n estÃ¡ ahora en vivo en:" >> $GITHUB_STEP_SUMMARY
            echo "**https://${{ inputs.azure-webapp-name }}.azurewebsites.net**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Azure Deployment**: FallÃ³ ($DEPLOY_STATUS)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• **Deployment Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
