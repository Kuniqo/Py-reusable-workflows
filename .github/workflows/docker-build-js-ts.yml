name: Docker Build JS/TS (Reusable)

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: "20"
        description: "Versi√≥n de Node.js"
      docker-registry:
        required: false
        type: string
        default: "ghcr.io"
        description: "Registro de Docker (ghcr.io, docker.io, etc.)"
      docker-image-name:
        required: true
        type: string
        description: "Nombre completo de la imagen (ej: org/app-name)"
      dockerfile-path:
        required: false
        type: string
        default: "./Dockerfile"
        description: "Ruta al Dockerfile"
      build-context:
        required: false
        type: string
        default: "."
        description: "Contexto de build"
      platforms:
        required: false
        type: string
        default: "linux/amd64"
        description: "Plataformas a construir (separadas por coma)"
      push-image:
        required: false
        type: boolean
        default: true
        description: "Push de la imagen al registry"
      build-args:
        required: false
        type: string
        default: ""
        description: "Build args (formato: KEY1=val1,KEY2=val2)"
    secrets:
      CR_PAT:
        required: false
        description: "Personal Access Token para GHCR (usa secrets.GITHUB_TOKEN si no est√° disponible)"

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    name: Build & Push Docker Image (JS/TS)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        id: download-build
        uses: actions/download-artifact@v4
        with:
          name: js-ts-package-${{ github.run_id }}
          path: ./build-artifacts
        continue-on-error: true

      - name: Extract build artifacts
        if: steps.download-build.outcome == 'success'
        run: |
          echo "üì¶ Extrayendo build artifacts para Docker..."

          # Buscar tarball con nombres posibles
          if [ -f "./build-artifacts/build-package.tar.gz" ]; then
            echo "‚úÖ Encontrado build-package.tar.gz (desde test.yml)"
            cd build-artifacts
            tar -xzf build-package.tar.gz
            rm build-package.tar.gz
            cd ..
          elif [ -f "./build-artifacts/build-artifacts.tar.gz" ]; then
            echo "‚úÖ Encontrado build-artifacts.tar.gz (desde build.yml)"
            cd build-artifacts
            tar -xzf build-artifacts.tar.gz
            rm build-artifacts.tar.gz
            cd ..
          elif [ -d "./build-artifacts/.next" ]; then
            echo "‚úÖ Encontrado .next/ directamente"
          else
            echo "‚ùå No se encontr√≥ build artifact"
            echo "Contenido de build-artifacts:"
            ls -la ./build-artifacts/ || echo "Directorio vac√≠o"
            exit 1
          fi

          # Mover .next al directorio ra√≠z para el build de Docker
          if [ -d "./build-artifacts/.next" ]; then
            echo "üìÅ Moviendo .next/ al directorio ra√≠z..."
            mv ./build-artifacts/.next ./.next
            echo "‚úÖ .next/ listo para Docker build"
            ls -lah .next/ | head -5
          else
            echo "‚ùå ERROR: .next/ no encontrado despu√©s de extraer"
            exit 1
          fi

      - name: Verify build artifacts
        run: |
          if [ ! -d ".next" ]; then
            echo "‚ùå ERROR: Directorio .next/ no encontrado"
            echo "No se puede construir imagen Docker sin el build"
            exit 1
          fi

          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "‚úÖ Build verificado: .next/ ($BUILD_SIZE)"
          echo "üìã Archivos en .next/:"
          ls -lah .next/ | head -10

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker-registry }}
          username: ${{ vars.GHCR_USERNAME || github.actor }}
          password: ${{ secrets.CR_PAT || secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.docker-registry }}/${{ inputs.docker-image-name }}
          tags: |
            # PR number (priority 600 - highest for PRs)
            type=ref,event=pr,priority=600
            # Branch name (priority 500)
            type=ref,event=branch,priority=500
            # SHA with branch prefix (only for branches, priority 400)
            type=sha,enable={{is_default_branch}},prefix={{branch}}-,priority=400
            # Semantic versioning (only for tags, priority 300)
            type=semver,pattern={{version}},priority=300
            type=semver,pattern={{major}}.{{minor}},priority=200
            # Latest (only for default branch, priority 100)
            type=raw,value=latest,enable={{is_default_branch}},priority=100

      - name: Parse build args
        id: build-args
        run: |
          BUILD_ARGS="${{ inputs.build-args }}"

          if [ -n "$BUILD_ARGS" ]; then
            echo "args<<EOF" >> $GITHUB_OUTPUT
            echo "$BUILD_ARGS" | tr ',' '\n' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "‚úÖ Build args configurados desde input"
          else
            echo "‚ÑπÔ∏è No se configuraron build args"
          fi

      - name: Build and push Docker image
        id: docker-build
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.build-context }}
          file: ${{ inputs.dockerfile-path }}
          platforms: ${{ inputs.platforms }}
          push: ${{ inputs.push-image }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: ${{ steps.build-args.outputs.args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest and summary
        run: |
          echo "üéâ Imagen Docker construida exitosamente"
          echo "üì¶ Image digest: ${{ steps.docker-build.outputs.digest }}"
          echo "üè∑Ô∏è  Tags:"
          echo "${{ steps.meta.outputs.tags }}"

          # Generar summary con informaci√≥n de la imagen
          echo "## üê≥ Docker Image Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Imagen construida y pusheada exitosamente**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extraer informaci√≥n del registry y nombre
          REGISTRY="${{ inputs.docker-registry }}"
          IMAGE_NAME="${{ inputs.docker-image-name }}"
          FIRST_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)

          # Generar URL del package seg√∫n el registry
          if [[ "$REGISTRY" == "ghcr.io" ]]; then
            # Para GHCR, extraer org/repo del image name
            ORG=$(echo "$IMAGE_NAME" | cut -d'/' -f1)
            PACKAGE=$(echo "$IMAGE_NAME" | cut -d'/' -f2)
            PACKAGE_URL="https://github.com/${ORG}/packages/container/package/${PACKAGE}"
          elif [[ "$REGISTRY" == "docker.io" ]]; then
            PACKAGE_URL="https://hub.docker.com/r/${IMAGE_NAME}"
          else
            PACKAGE_URL="${REGISTRY}/${IMAGE_NAME}"
          fi

          echo "### üì¶ Package Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${REGISTRY}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${IMAGE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Package URL**: ${PACKAGE_URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üè∑Ô∏è Tags Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üöÄ Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${FIRST_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üìä Image Digest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.docker-build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
