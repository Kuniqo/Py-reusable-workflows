name: Lint (Reusable - Python)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: "3.12"
      fail-on-lint-errors:
        required: false
        type: boolean
        default: false
        description: "Fallar el workflow si hay errores de lint"
    outputs:
      has_critical_errors:
        description: "Numero de errores criticos (E series)"
        value: ${{ jobs.python-lint.outputs.has_critical_errors }}
      total_errors:
        description: "Total de errores"
        value: ${{ jobs.python-lint.outputs.total_errors }}
      total_warnings:
        description: "Total de warnings"
        value: ${{ jobs.python-lint.outputs.total_warnings }}

permissions:
  contents: read
  pull-requests: write

jobs:
  python-lint:
    name: Python Lint (Ruff)
    runs-on: ubuntu-latest
    outputs:
      has_critical_errors: ${{ steps.lint.outputs.has_critical_errors }}
      total_errors: ${{ steps.lint.outputs.total_errors }}
      total_warnings: ${{ steps.lint.outputs.total_warnings }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install ruff mypy

      - name: Run Ruff lint checks
        id: lint
        run: |
          echo "Ejecutando Ruff lint checks..."

          # Ejecutar Ruff y capturar salida
          set +e
          ruff check . --output-format=github > ruff-output.txt 2>&1
          RUFF_EXIT=$?
          set -e

          cat ruff-output.txt

          # Contar errores por severidad
          # Errores criticos: Solo E series (sintaxis, indentacion, comparaciones)
          CRITICAL_ERRORS=$(grep -E "\[E[0-9]{3}\]" ruff-output.txt 2>/dev/null | wc -l || echo "0")
          CRITICAL_ERRORS=$(echo "$CRITICAL_ERRORS" | tr -d '[:space:]')

          # Contar total de lineas de error
          TOTAL_ERRORS=$(grep "^Error:" ruff-output.txt 2>/dev/null | wc -l || echo "0")
          TOTAL_ERRORS=$(echo "$TOTAL_ERRORS" | tr -d '[:space:]')

          # Warnings
          TOTAL_WARNINGS=$(grep "^Warning:" ruff-output.txt 2>/dev/null | wc -l || echo "0")
          TOTAL_WARNINGS=$(echo "$TOTAL_WARNINGS" | tr -d '[:space:]')

          # Asegurar que son numeros validos
          CRITICAL_ERRORS=${CRITICAL_ERRORS:-0}
          TOTAL_ERRORS=${TOTAL_ERRORS:-0}
          TOTAL_WARNINGS=${TOTAL_WARNINGS:-0}

          # Guardar outputs
          echo "has_critical_errors=${CRITICAL_ERRORS}" >> "$GITHUB_OUTPUT"
          echo "total_errors=${TOTAL_ERRORS}" >> "$GITHUB_OUTPUT"
          echo "total_warnings=${TOTAL_WARNINGS}" >> "$GITHUB_OUTPUT"

          echo "Resultados del linting:"
          echo "  Errores criticos (E series): ${CRITICAL_ERRORS}"
          echo "  Total de errores: ${TOTAL_ERRORS}"
          echo "  Warnings: ${TOTAL_WARNINGS}"

          # Evaluar resultados
          if [ "${CRITICAL_ERRORS}" -gt 0 ]; then
            echo "FALLA: Se encontraron ${CRITICAL_ERRORS} errores criticos (E series)"
            echo "::error::Se encontraron ${CRITICAL_ERRORS} errores criticos de sintaxis/estructura que deben corregirse"
            exit 1
          elif [ "${TOTAL_ERRORS}" -gt 0 ]; then
            echo "Se encontraron ${TOTAL_ERRORS} errores no criticos (imports no usados, variables, etc.)"
            echo "::warning::Se encontraron ${TOTAL_ERRORS} errores de estilo/calidad. Ejecuta 'ruff check . --fix' localmente para corregir"
            exit 0
          else
            echo "Ruff paso sin errores"
            exit 0
          fi
