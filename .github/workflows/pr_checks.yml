name: Pull Request Checks (Reusable - Python)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: "3.12"
      coverage-min:
        required: false
        type: number
        default: 70
      fail-on-lint-errors:
        required: false
        type: boolean
        default: true
        description: "Fallar si hay errores de lint"
      build-docker-image:
        required: false
        type: boolean
        default: false
        description: "Construir imagen Docker despues de checks exitosos"
      docker-registry:
        required: false
        type: string
        default: "ghcr.io"
        description: "Registro de Docker (ghcr.io, docker.io, etc.)"
      docker-image-name:
        required: false
        type: string
        description: "Nombre de la imagen Docker (ej: org/app-name)"
      docker-build-args:
        required: false
        type: string
        default: ""
        description: "Build args para Docker"
    secrets:
      GITHUB_TOKEN:
        required: false
        description: "GitHub token for API access"

jobs:
  # ==============================
  #  JOB 1: LINT
  # ==============================
  lint:
    name: Python Lint (Ruff)
    runs-on: ubuntu-latest
    outputs:
      has_critical_errors: ${{ steps.lint.outputs.has_critical_errors }}
      total_errors: ${{ steps.lint.outputs.total_errors }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" 2>/dev/null || pip install ruff
          pip install ruff

      - name: Run Ruff lint
        id: lint
        run: |
          set +e
          ruff check . --output-format=github > ruff-output.txt 2>&1
          RUFF_EXIT=$?
          set -e
          cat ruff-output.txt

          CRITICAL_ERRORS=$(grep -E "\[E[0-9]{3}\]" ruff-output.txt 2>/dev/null | wc -l || echo "0")
          CRITICAL_ERRORS=$(echo "$CRITICAL_ERRORS" | tr -d '[:space:]')
          TOTAL_ERRORS=$(grep -c ":" ruff-output.txt 2>/dev/null || echo "0")

          echo "has_critical_errors=${CRITICAL_ERRORS}" >> "$GITHUB_OUTPUT"
          echo "total_errors=${TOTAL_ERRORS}" >> "$GITHUB_OUTPUT"

          if [ "${CRITICAL_ERRORS}" -gt 0 ]; then
            echo "::error::Errores criticos encontrados: ${CRITICAL_ERRORS}"
            exit 1
          fi
          exit 0

  # ==============================
  #  JOB 2: BUILD
  # ==============================
  build:
    name: Build Python Package
    runs-on: ubuntu-latest
    needs: lint
    if: |
      always() &&
      !cancelled() &&
      (needs.lint.result == 'success' || needs.lint.result == 'failure')
    outputs:
      build_outcome: ${{ steps.build.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" 2>/dev/null || pip install build
          pip install build

      - name: Build package
        id: build
        run: |
          set +e
          python -m build > build-output.txt 2>&1
          BUILD_EXIT=$?
          set -e
          cat build-output.txt

          if [ $BUILD_EXIT -eq 0 ]; then
            echo "Build exitoso"
            ls -lh dist/
            exit 0
          else
            echo "::error::Build fallo"
            exit 1
          fi

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: python-build-artifacts-${{ github.run_id }}
          path: dist/
          retention-days: 1

  # ==============================
  #  JOB 3: TESTS & COVERAGE
  # ==============================
  tests:
    name: Python Tests & Coverage
    runs-on: ubuntu-latest
    needs: [lint, build]
    if: |
      always() &&
      !cancelled() &&
      needs.build.result == 'success'
    outputs:
      coverage_percent: ${{ steps.pytest.outputs.coverage_percent }}
      coverage_ok: ${{ steps.pytest.outputs.coverage_ok }}
      has_critical_errors: ${{ steps.pytest.outputs.has_critical_errors }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" 2>/dev/null || pip install pytest pytest-cov
          pip install pytest pytest-cov

      - name: Run tests
        id: pytest
        continue-on-error: true
        run: |
          set +e
          pytest --cov=. --cov-report=term --cov-report=xml -v > pytest-output.txt 2>&1
          PYTEST_EXIT=$?
          set -e
          cat pytest-output.txt

          HAS_CRITICAL_ERRORS="false"
          COVERAGE_OK="true"

          if [ -f "coverage.xml" ]; then
            COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage.xml | head -1 || echo "0")
            COVERAGE_PERCENT=$(echo "$COVERAGE * 100" | bc | cut -d. -f1)
            echo "coverage_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT

            if [ "$COVERAGE_PERCENT" -ge ${{ inputs.coverage-min }} ]; then
              COVERAGE_OK="true"
            else
              COVERAGE_OK="false"
            fi
          else
            echo "coverage_percent=0" >> $GITHUB_OUTPUT
            COVERAGE_OK="true"
          fi

          echo "coverage_ok=$COVERAGE_OK" >> $GITHUB_OUTPUT
          echo "has_critical_errors=$HAS_CRITICAL_ERRORS" >> $GITHUB_OUTPUT

          if [ $PYTEST_EXIT -eq 5 ]; then
            echo "::warning::No tests found"
            exit 0
          fi
          exit 0

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage-${{ github.run_id }}
          path: |
            htmlcov/
            coverage.xml
          retention-days: 7
          if-no-files-found: ignore

  # ==============================
  #  JOB 4: BUILD DOCKER (Optional)
  # ==============================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, tests]
    if: |
      always() &&
      !cancelled() &&
      needs.tests.result == 'success' &&
      inputs.build-docker-image == true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker-registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ inputs.docker-registry }}/${{ inputs.docker-image-name }}:pr-${{ github.event.number }}

  # ==============================
  #  JOB 5: SUMMARY
  # ==============================
  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [lint, build, tests, build-docker]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## PR Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.tests.result }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.build-docker-image }}" == "true" ]; then
            echo "| Docker | ${{ needs.build-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
