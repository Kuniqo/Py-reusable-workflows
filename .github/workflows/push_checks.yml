name: Push Checks (Reusable - Python)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: "3.12"
      skip-tests:
        required: false
        type: boolean
        default: false
      coverage-min:
        required: false
        type: number
        default: 60
        description: "Porcentaje minimo de coverage requerido"
      fail-on-lint-errors:
        required: false
        type: boolean
        default: false
    secrets:
      CR_PAT:
        required: false
        description: "Personal Access Token para GHCR"

permissions:
  contents: read
  pull-requests: write

jobs:
  # ==============================
  #  JOB 1: LINT
  # ==============================
  lint:
    name: Lint Checks
    uses: ./.github/workflows/lint.yml
    with:
      python-version: ${{ inputs.python-version }}
      fail-on-lint-errors: ${{ inputs.fail-on-lint-errors }}

  # ==============================
  #  JOB 2: BUILD
  # ==============================
  build:
    name: Build Packages
    needs: lint
    if: needs.lint.result == 'success'
    uses: ./.github/workflows/build.yml
    with:
      python-version: ${{ inputs.python-version }}

  # ==============================
  #  JOB 3: TESTS & COVERAGE
  # ==============================
  tests:
    name: Tests & Coverage
    needs: [lint, build]
    if: |
      needs.lint.result == 'success' &&
      needs.build.result == 'success'
    uses: ./.github/workflows/test.yml
    with:
      python-version: ${{ inputs.python-version }}
      coverage-min: ${{ inputs.coverage-min }}
      skip-tests: ${{ inputs.skip-tests }}

  # ==============================
  #  JOB 4: RESUMEN FINAL
  # ==============================
  workflow-summary:
    name: Resumen del Workflow
    runs-on: ubuntu-latest
    needs: [lint, build, tests]
    if: always()

    steps:
      - name: Generate Workflow Summary
        run: |
          echo "## Resumen del Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Informacion General:**" >> $GITHUB_STEP_SUMMARY
          echo "- Lenguaje: Python" >> $GITHUB_STEP_SUMMARY
          echo "- Python version: \`${{ inputs.python-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Python Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Lint status
          LINT_STATUS="${{ needs.lint.result }}"
          CRITICAL_ERRORS="${{ needs.lint.outputs.has_critical_errors }}"
          TOTAL_ERRORS="${{ needs.lint.outputs.total_errors }}"
          TOTAL_WARNINGS="${{ needs.lint.outputs.total_warnings }}"

          if [ "$LINT_STATUS" == "success" ]; then
            if [ "$TOTAL_ERRORS" -gt 0 ] 2>/dev/null; then
              echo "- Lint (Ruff): $TOTAL_ERRORS errores no criticos, $TOTAL_WARNINGS warnings" >> $GITHUB_STEP_SUMMARY
              echo "  - Ejecuta \`ruff check . --fix\` localmente para corregir" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Lint (Ruff): Paso sin errores criticos" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$LINT_STATUS" == "failure" ]; then
            echo "- Lint (Ruff): Fallo ($CRITICAL_ERRORS errores criticos)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Lint (Ruff): $LINT_STATUS" >> $GITHUB_STEP_SUMMARY
          fi

          # Build status
          BUILD_STATUS="${{ needs.build.result }}"
          if [ "$BUILD_STATUS" == "success" ]; then
            echo "- Build: Paquete construido exitosamente" >> $GITHUB_STEP_SUMMARY
          elif [ "$BUILD_STATUS" == "failure" ]; then
            echo "- Build: Fallo al construir el paquete" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Build: $BUILD_STATUS" >> $GITHUB_STEP_SUMMARY
          fi

          # Tests y Coverage
          PYTEST_OUTCOME="${{ needs.tests.outputs.pytest_outcome }}"
          TESTS_PASSED="${{ needs.tests.outputs.tests_passed }}"
          TESTS_FAILED="${{ needs.tests.outputs.tests_failed }}"
          COVERAGE="${{ needs.tests.outputs.coverage_percent }}"
          COVERAGE_OK="${{ needs.tests.outputs.coverage_ok }}"
          HAS_CRITICAL="${{ needs.tests.outputs.has_critical_errors }}"

          if [ "$PYTEST_OUTCOME" == "success" ]; then
            echo "- Tests: Todos pasaron ($TESTS_PASSED tests)" >> $GITHUB_STEP_SUMMARY
          elif [ "$PYTEST_OUTCOME" == "failure" ]; then
            echo "- Tests: $TESTS_FAILED fallaron, $TESTS_PASSED pasaron" >> $GITHUB_STEP_SUMMARY

            # Indicar si hay errores criticos
            if [ "$HAS_CRITICAL" == "true" ]; then
              echo "  - Contiene errores CRITICOS (Exception, ERROR, Fatal)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- Tests: No ejecutados o sin tests" >> $GITHUB_STEP_SUMMARY
          fi

          # Coverage con indicador de suficiencia para Docker build
          if [ -n "$COVERAGE" ] && [ "$COVERAGE" != "0" ]; then
            if [ "$COVERAGE" -ge 80 ]; then
              echo "- Coverage: ${COVERAGE}% (Excelente, suficiente para Docker build)" >> $GITHUB_STEP_SUMMARY
            elif [ "$COVERAGE" -ge 60 ]; then
              echo "- Coverage: ${COVERAGE}% (Aceptable, suficiente para Docker build)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Coverage: ${COVERAGE}% (Insuficiente, minimo 60% para Docker build)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- Coverage: No disponible o 0%" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tip**: Descarga el reporte de coverage desde la seccion de Artifacts" >> $GITHUB_STEP_SUMMARY
