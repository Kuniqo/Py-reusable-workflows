name: Test Docker Build (Reusable - No Push)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: '3.12'
        description: 'Python version'
      node-version:
        required: false
        type: string
        default: '20'
        description: 'Node version'
      docker-image-name:
        required: true
        type: string
        description: 'Docker image name (e.g., org/app-name) - Solo para referencia, NO se publicar√°'
      language:
        required: false
        type: string
        default: 'auto-detect'
        description: 'Lenguaje del proyecto: python, javascript, typescript, o auto-detect'
    outputs:
      build_successful:
        description: "Si el build de Docker fue exitoso"
        value: ${{ jobs.test-summary.outputs.build_successful }}
      image_size:
        description: "Tama√±o de la imagen Docker (bytes)"
        value: ${{ jobs.build-docker-python.outputs.image_size || jobs.build-docker-js-ts.outputs.image_size }}
      vulnerabilities_found:
        description: "Si se encontraron vulnerabilidades cr√≠ticas"
        value: ${{ jobs.build-docker-python.outputs.vulnerabilities || jobs.build-docker-js-ts.outputs.vulnerabilities }}
      language_detected:
        description: "Lenguaje detectado del proyecto"
        value: ${{ jobs.detect-language.outputs.language }}

  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version'
        required: false
        default: '3.12'
        type: string
      node-version:
        description: 'Node version'
        required: false
        default: '20'
        type: string
      docker-image-name:
        description: 'Docker image name (e.g., org/app-name) - Solo para referencia, NO se publicar√°'
        required: true
        type: string
      language:
        description: 'Tipo de proyecto a testear'
        required: false
        default: 'auto-detect'
        type: choice
        options:
          - auto-detect
          - python
          - javascript
          - typescript

permissions:
  contents: read

jobs:
  # ==============================
  #  JOB 1: DETECTAR LENGUAJE
  # ==============================
  detect-language:
    name: Detectar Lenguaje del Proyecto
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.detect.outputs.lang }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        run: |
          LANGUAGE="${{ inputs.language }}"

          if [ "$LANGUAGE" != "auto-detect" ]; then
            echo "lang=$LANGUAGE" >> $GITHUB_OUTPUT
            echo "üìù Usando lenguaje especificado: $LANGUAGE"
          else
            # Auto-detecci√≥n
            if [ -f "pyproject.toml" ]; then
              echo "lang=python" >> $GITHUB_OUTPUT
              echo "üêç Proyecto Python detectado"
            elif [ -f "package.json" ]; then
              if grep -q '"typescript"' package.json || [ -f "tsconfig.json" ]; then
                echo "lang=typescript" >> $GITHUB_OUTPUT
                echo "üìò Proyecto TypeScript detectado"
              else
                echo "lang=javascript" >> $GITHUB_OUTPUT
                echo "üìó Proyecto JavaScript detectado"
              fi
            else
              echo "lang=unknown" >> $GITHUB_OUTPUT
              echo "‚ùå Lenguaje no detectado"
              exit 1
            fi
          fi

  # ==============================
  #  JOB 2: VALIDAR DOCKERFILE (Python)
  # ==============================
  validate-dockerfile-python:
    name: Validar Dockerfile Python
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.language == 'python'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "‚úÖ Dockerfile encontrado"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Dockerfile NO encontrado"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate Dockerfile syntax
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "üîç Validando sintaxis del Dockerfile..."
          docker run --rm -i hadolint/hadolint < Dockerfile || true
          echo "‚úÖ Validaci√≥n completada"

      - name: Check required files for Python
        run: |
          echo "üîç Verificando archivos requeridos para Python..."

          MISSING_FILES=""

          if [ ! -f "pyproject.toml" ]; then
            MISSING_FILES="$MISSING_FILES pyproject.toml"
            echo "‚ö†Ô∏è pyproject.toml no encontrado"
          fi

          if [ ! -f "requirements.txt" ] && [ ! -f "pyproject.toml" ]; then
            echo "‚ö†Ô∏è Ni requirements.txt ni pyproject.toml con dependencies encontrado"
          fi

          if [ -n "$MISSING_FILES" ]; then
            echo "‚ùå Archivos faltantes: $MISSING_FILES"
            echo "üí° Aseg√∫rate de tener al menos pyproject.toml para instalar dependencias"
          else
            echo "‚úÖ Todos los archivos necesarios est√°n presentes"
          fi

  # ==============================
  #  JOB 3: BUILD DOCKER IMAGE (Python) - LOCAL ONLY
  # ==============================
  build-docker-python:
    name: Build Docker Image (Python) - Test Local
    runs-on: ubuntu-latest
    needs: [detect-language, validate-dockerfile-python]
    if: needs.detect-language.outputs.language == 'python'
    outputs:
      image_size: ${{ steps.inspect.outputs.image_size }}
      vulnerabilities: ${{ steps.trivy.outputs.vulnerabilities }}
      build_status: ${{ steps.build.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (NO PUSH)
        id: build
        run: |
          echo "üî® Construyendo imagen Docker localmente (NO se publicar√°)..."

          IMAGE_NAME="${{ inputs.docker-image-name }}"
          IMAGE_TAG="test-$(git rev-parse --short HEAD)"
          FULL_IMAGE="${IMAGE_NAME}:${IMAGE_TAG}"

          echo "üì¶ Imagen: $FULL_IMAGE"

          # Build sin push
          docker buildx build \
            --platform linux/amd64 \
            --tag "$FULL_IMAGE" \
            --build-arg PYTHON_VERSION="${{ inputs.python-version }}" \
            --load \
            .

          echo "‚úÖ Build exitoso!"
          echo "image_name=$FULL_IMAGE" >> $GITHUB_OUTPUT

      - name: Inspect Docker image
        id: inspect
        run: |
          IMAGE_NAME="${{ steps.build.outputs.image_name }}"

          echo "üîç Inspeccionando imagen Docker..."
          docker images "$IMAGE_NAME"

          echo ""
          echo "üìä Detalles de la imagen:"
          IMAGE_SIZE=$(docker inspect "$IMAGE_NAME" --format='{{.Size}}')
          echo "Tama√±o: $IMAGE_SIZE bytes"
          echo "image_size=$IMAGE_SIZE" >> $GITHUB_OUTPUT

          docker inspect "$IMAGE_NAME" --format='Arquitectura: {{.Architecture}}'
          docker inspect "$IMAGE_NAME" --format='OS: {{.Os}}'

          echo ""
          echo "üìã Layers:"
          docker history "$IMAGE_NAME" --no-trunc

      - name: Test Docker image
        continue-on-error: true
        run: |
          IMAGE_NAME="${{ steps.build.outputs.image_name }}"

          echo "üß™ Probando imagen Docker..."

          # Intentar ejecutar la imagen
          echo "Ejecutando: docker run --rm $IMAGE_NAME --version"
          docker run --rm "$IMAGE_NAME" python --version || echo "‚ö†Ô∏è No se pudo ejecutar python --version"

          # Verificar que pip est√° instalado
          echo "Ejecutando: docker run --rm $IMAGE_NAME pip --version"
          docker run --rm "$IMAGE_NAME" pip --version || echo "‚ö†Ô∏è No se pudo ejecutar pip --version"

      - name: Scan for vulnerabilities (Trivy)
        id: trivy
        continue-on-error: true
        run: |
          IMAGE_NAME="${{ steps.build.outputs.image_name }}"

          echo "üîç Escaneando vulnerabilidades con Trivy..."

          # Escanear y capturar resultado
          trivy image --severity CRITICAL,HIGH --exit-code 1 "$IMAGE_NAME" > trivy-output.txt 2>&1 || true

          if grep -qi "Total: 0" trivy-output.txt; then
            echo "vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No se encontraron vulnerabilidades cr√≠ticas"
          else
            echo "vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Se encontraron vulnerabilidades"
            cat trivy-output.txt
          fi

  # ==============================
  #  JOB 4: VALIDAR DOCKERFILE (JS/TS)
  # ==============================
  validate-dockerfile-js-ts:
    name: Validar Dockerfile JavaScript/TypeScript
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.language == 'javascript' || needs.detect-language.outputs.language == 'typescript'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "‚úÖ Dockerfile encontrado"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Dockerfile NO encontrado"
            echo "‚ö†Ô∏è Para proyectos JS/TS, necesitas crear un Dockerfile"
            echo ""
            echo "Ejemplo de Dockerfile para Node.js:"
            echo "======================================"
            cat <<'EOF'
          FROM node:20-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci --only=production
          COPY . .
          RUN npm run build
          EXPOSE 3000
          CMD ["npm", "start"]
          EOF
            echo "======================================"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate Dockerfile syntax
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "üîç Validando sintaxis del Dockerfile..."
          docker run --rm -i hadolint/hadolint < Dockerfile || true
          echo "‚úÖ Validaci√≥n completada"

      - name: Check required files for JS/TS
        run: |
          echo "üîç Verificando archivos requeridos para JavaScript/TypeScript..."

          MISSING_FILES=""

          if [ ! -f "package.json" ]; then
            MISSING_FILES="$MISSING_FILES package.json"
            echo "‚ùå package.json no encontrado"
          else
            echo "‚úÖ package.json encontrado"

            # Check for build script
            if grep -q '"build"' package.json; then
              echo "‚úÖ Script 'build' encontrado en package.json"
            else
              echo "‚ö†Ô∏è No se encontr√≥ script 'build' en package.json"
            fi

            # Check for start script
            if grep -q '"start"' package.json; then
              echo "‚úÖ Script 'start' encontrado en package.json"
            else
              echo "‚ö†Ô∏è No se encontr√≥ script 'start' en package.json"
            fi
          fi

          if [ -n "$MISSING_FILES" ]; then
            echo "‚ùå Archivos faltantes: $MISSING_FILES"
            exit 1
          fi

  # ==============================
  #  JOB 5: BUILD DOCKER IMAGE (JS/TS) - LOCAL ONLY
  # ==============================
  build-docker-js-ts:
    name: Build Docker Image (JS/TS) - Test Local
    runs-on: ubuntu-latest
    needs: [detect-language, validate-dockerfile-js-ts]
    if: needs.detect-language.outputs.language == 'javascript' || needs.detect-language.outputs.language == 'typescript'
    outputs:
      image_size: ${{ steps.inspect.outputs.image_size }}
      vulnerabilities: ${{ steps.trivy.outputs.vulnerabilities }}
      build_status: ${{ steps.build.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (NO PUSH)
        id: build
        run: |
          echo "üî® Construyendo imagen Docker localmente (NO se publicar√°)..."

          IMAGE_NAME="${{ inputs.docker-image-name }}"
          IMAGE_TAG="test-$(git rev-parse --short HEAD)"
          FULL_IMAGE="${IMAGE_NAME}:${IMAGE_TAG}"

          echo "üì¶ Imagen: $FULL_IMAGE"

          # Build sin push
          docker buildx build \
            --platform linux/amd64 \
            --tag "$FULL_IMAGE" \
            --build-arg NODE_VERSION="${{ inputs.node-version }}" \
            --load \
            .

          echo "‚úÖ Build exitoso!"
          echo "image_name=$FULL_IMAGE" >> $GITHUB_OUTPUT

      - name: Inspect Docker image
        id: inspect
        run: |
          IMAGE_NAME="${{ steps.build.outputs.image_name }}"

          echo "üîç Inspeccionando imagen Docker..."
          docker images "$IMAGE_NAME"

          echo ""
          echo "üìä Detalles de la imagen:"
          IMAGE_SIZE=$(docker inspect "$IMAGE_NAME" --format='{{.Size}}')
          echo "Tama√±o: $IMAGE_SIZE bytes"
          echo "image_size=$IMAGE_SIZE" >> $GITHUB_OUTPUT

          docker inspect "$IMAGE_NAME" --format='Arquitectura: {{.Architecture}}'
          docker inspect "$IMAGE_NAME" --format='OS: {{.Os}}'

          echo ""
          echo "üìã Layers:"
          docker history "$IMAGE_NAME" --no-trunc

      - name: Test Docker image
        continue-on-error: true
        run: |
          IMAGE_NAME="${{ steps.build.outputs.image_name }}"

          echo "üß™ Probando imagen Docker..."

          # Intentar ejecutar la imagen
          echo "Ejecutando: docker run --rm $IMAGE_NAME node --version"
          docker run --rm "$IMAGE_NAME" node --version || echo "‚ö†Ô∏è No se pudo ejecutar node --version"

          # Verificar que npm est√° instalado
          echo "Ejecutando: docker run --rm $IMAGE_NAME npm --version"
          docker run --rm "$IMAGE_NAME" npm --version || echo "‚ö†Ô∏è No se pudo ejecutar npm --version"

      - name: Scan for vulnerabilities (Trivy)
        id: trivy
        continue-on-error: true
        run: |
          IMAGE_NAME="${{ steps.build.outputs.image_name }}"

          echo "üîç Escaneando vulnerabilidades con Trivy..."

          # Escanear y capturar resultado
          trivy image --severity CRITICAL,HIGH --exit-code 1 "$IMAGE_NAME" > trivy-output.txt 2>&1 || true

          if grep -qi "Total: 0" trivy-output.txt; then
            echo "vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No se encontraron vulnerabilidades cr√≠ticas"
          else
            echo "vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Se encontraron vulnerabilidades"
            cat trivy-output.txt
          fi

  # ==============================
  #  JOB 6: SUMMARY
  # ==============================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [detect-language, build-docker-python, build-docker-js-ts]
    if: always()
    outputs:
      build_successful: ${{ steps.set-output.outputs.build_successful }}

    steps:
      - name: Generate Test Summary
        id: set-output
        run: |
          echo "## üß™ Resumen del Test de Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          LANGUAGE="${{ needs.detect-language.outputs.language }}"
          echo "**Lenguaje detectado:** $LANGUAGE" >> $GITHUB_STEP_SUMMARY
          echo "**Imagen de prueba:** \`${{ inputs.docker-image-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$LANGUAGE" == "python" ]; then
            BUILD_STATUS="${{ needs.build-docker-python.result }}"

            if [ "$BUILD_STATUS" == "success" ]; then
              echo "### ‚úÖ Build Exitoso (Python)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "La imagen Docker se construy√≥ correctamente. Puedes proceder a:" >> $GITHUB_STEP_SUMMARY
              echo "1. Ejecutar \`deploy-staging.yml\` para construir y publicar la imagen" >> $GITHUB_STEP_SUMMARY
              echo "2. Configurar deployment scripts para staging/production" >> $GITHUB_STEP_SUMMARY
            else
              echo "### ‚ùå Build Fall√≥ (Python)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Acciones recomendadas:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Revisa los logs del job \`build-docker-python\`" >> $GITHUB_STEP_SUMMARY
              echo "2. Verifica que el Dockerfile existe y est√° bien formado" >> $GITHUB_STEP_SUMMARY
              echo "3. Aseg√∫rate de que \`pyproject.toml\` tiene todas las dependencias" >> $GITHUB_STEP_SUMMARY
              echo "4. Revisa los errores de build en los steps anteriores" >> $GITHUB_STEP_SUMMARY
            fi

          elif [ "$LANGUAGE" == "javascript" ] || [ "$LANGUAGE" == "typescript" ]; then
            BUILD_STATUS="${{ needs.build-docker-js-ts.result }}"

            if [ "$BUILD_STATUS" == "success" ]; then
              echo "### ‚úÖ Build Exitoso (JS/TS)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "La imagen Docker se construy√≥ correctamente. Pr√≥ximos pasos:" >> $GITHUB_STEP_SUMMARY
              echo "1. Crear workflow similar a \`deploy-staging.yml\` para JS/TS" >> $GITHUB_STEP_SUMMARY
              echo "2. Configurar deployment scripts para tu infraestructura" >> $GITHUB_STEP_SUMMARY
            else
              echo "### ‚ùå Build Fall√≥ (JS/TS)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Acciones recomendadas:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Revisa los logs del job \`build-docker-js-ts\`" >> $GITHUB_STEP_SUMMARY
              echo "2. Verifica que el Dockerfile existe (ver ejemplo en logs)" >> $GITHUB_STEP_SUMMARY
              echo "3. Aseg√∫rate de que \`package.json\` tiene scripts 'build' y 'start'" >> $GITHUB_STEP_SUMMARY
              echo "4. Revisa los errores de build en los steps anteriores" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üí° **Nota:** Esta imagen NO fue publicada a ning√∫n registry. Es solo una prueba local." >> $GITHUB_STEP_SUMMARY

          # Establecer output para workflow reusable
          LANGUAGE="${{ needs.detect-language.outputs.language }}"
          if [ "$LANGUAGE" == "python" ]; then
            BUILD_STATUS="${{ needs.build-docker-python.result }}"
          elif [ "$LANGUAGE" == "javascript" ] || [ "$LANGUAGE" == "typescript" ]; then
            BUILD_STATUS="${{ needs.build-docker-js-ts.result }}"
          else
            BUILD_STATUS="skipped"
          fi

          if [ "$BUILD_STATUS" == "success" ]; then
            echo "build_successful=true" >> $GITHUB_OUTPUT
          else
            echo "build_successful=false" >> $GITHUB_OUTPUT
          fi
