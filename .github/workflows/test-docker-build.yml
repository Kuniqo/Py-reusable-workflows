name: Test Docker Build (Reusable - Python - No Push)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: '3.12'
        description: 'Python version'
      docker-image-name:
        required: true
        type: string
        description: 'Docker image name (e.g., org/app-name) - Solo para referencia, NO se publicara'
    outputs:
      build_successful:
        description: "Si el build de Docker fue exitoso"
        value: ${{ jobs.test-summary.outputs.build_successful }}
      image_size:
        description: "Tamano de la imagen Docker (bytes)"
        value: ${{ jobs.build-docker-python.outputs.image_size }}
      vulnerabilities_found:
        description: "Si se encontraron vulnerabilidades criticas"
        value: ${{ jobs.build-docker-python.outputs.vulnerabilities }}

  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version'
        required: false
        default: '3.12'
        type: string
      docker-image-name:
        description: 'Docker image name (e.g., org/app-name) - Solo para referencia, NO se publicara'
        required: true
        type: string

permissions:
  contents: read

jobs:
  # ==============================
  #  JOB 1: VALIDAR DOCKERFILE
  # ==============================
  validate-dockerfile:
    name: Validar Dockerfile Python
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "Dockerfile encontrado"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Dockerfile NO encontrado"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate Dockerfile syntax
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "Validando sintaxis del Dockerfile..."
          docker run --rm -i hadolint/hadolint < Dockerfile || true
          echo "Validacion completada"

      - name: Check required files for Python
        run: |
          echo "Verificando archivos requeridos para Python..."

          MISSING_FILES=""

          if [ ! -f "pyproject.toml" ]; then
            MISSING_FILES="$MISSING_FILES pyproject.toml"
            echo "pyproject.toml no encontrado"
          fi

          if [ ! -f "requirements.txt" ] && [ ! -f "pyproject.toml" ]; then
            echo "Ni requirements.txt ni pyproject.toml con dependencies encontrado"
          fi

          if [ -n "$MISSING_FILES" ]; then
            echo "Archivos faltantes: $MISSING_FILES"
            echo "Asegurate de tener al menos pyproject.toml para instalar dependencias"
          else
            echo "Todos los archivos necesarios estan presentes"
          fi

  # ==============================
  #  JOB 2: BUILD DOCKER IMAGE - LOCAL ONLY
  # ==============================
  build-docker-python:
    name: Build Docker Image (Python) - Test Local
    runs-on: ubuntu-latest
    needs: validate-dockerfile
    outputs:
      image_size: ${{ steps.inspect.outputs.image_size }}
      vulnerabilities: ${{ steps.trivy.outputs.vulnerabilities }}
      build_status: ${{ steps.build.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (NO PUSH)
        id: build
        run: |
          echo "Construyendo imagen Docker localmente (NO se publicara)..."

          IMAGE_NAME="${{ inputs.docker-image-name }}"
          IMAGE_TAG="test-$(git rev-parse --short HEAD)"
          FULL_IMAGE="${IMAGE_NAME}:${IMAGE_TAG}"

          echo "Imagen: $FULL_IMAGE"

          # Build sin push
          docker buildx build \
            --platform linux/amd64 \
            --tag "$FULL_IMAGE" \
            --build-arg PYTHON_VERSION="${{ inputs.python-version }}" \
            --load \
            .

          echo "Build exitoso!"
          echo "image_name=$FULL_IMAGE" >> $GITHUB_OUTPUT

      - name: Inspect Docker image
        id: inspect
        run: |
          IMAGE_NAME="${{ steps.build.outputs.image_name }}"

          echo "Inspeccionando imagen Docker..."
          docker images "$IMAGE_NAME"

          echo ""
          echo "Detalles de la imagen:"
          IMAGE_SIZE=$(docker inspect "$IMAGE_NAME" --format='{{.Size}}')
          echo "Tamano: $IMAGE_SIZE bytes"
          echo "image_size=$IMAGE_SIZE" >> $GITHUB_OUTPUT

          docker inspect "$IMAGE_NAME" --format='Arquitectura: {{.Architecture}}'
          docker inspect "$IMAGE_NAME" --format='OS: {{.Os}}'

          echo ""
          echo "Layers:"
          docker history "$IMAGE_NAME" --no-trunc

      - name: Test Docker image
        continue-on-error: true
        run: |
          IMAGE_NAME="${{ steps.build.outputs.image_name }}"

          echo "Probando imagen Docker..."

          # Intentar ejecutar la imagen
          echo "Ejecutando: docker run --rm $IMAGE_NAME --version"
          docker run --rm "$IMAGE_NAME" python --version || echo "No se pudo ejecutar python --version"

          # Verificar que pip esta instalado
          echo "Ejecutando: docker run --rm $IMAGE_NAME pip --version"
          docker run --rm "$IMAGE_NAME" pip --version || echo "No se pudo ejecutar pip --version"

      - name: Scan for vulnerabilities (Trivy)
        id: trivy
        continue-on-error: true
        run: |
          IMAGE_NAME="${{ steps.build.outputs.image_name }}"

          echo "Escaneando vulnerabilidades con Trivy..."

          # Escanear y capturar resultado
          trivy image --severity CRITICAL,HIGH --exit-code 1 "$IMAGE_NAME" > trivy-output.txt 2>&1 || true

          if grep -qi "Total: 0" trivy-output.txt; then
            echo "vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "No se encontraron vulnerabilidades criticas"
          else
            echo "vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "Se encontraron vulnerabilidades"
            cat trivy-output.txt
          fi

  # ==============================
  #  JOB 3: SUMMARY
  # ==============================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: build-docker-python
    if: always()
    outputs:
      build_successful: ${{ steps.set-output.outputs.build_successful }}

    steps:
      - name: Generate Test Summary
        id: set-output
        run: |
          echo "## Resumen del Test de Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Lenguaje:** Python" >> $GITHUB_STEP_SUMMARY
          echo "**Imagen de prueba:** \`${{ inputs.docker-image-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          BUILD_STATUS="${{ needs.build-docker-python.result }}"

          if [ "$BUILD_STATUS" == "success" ]; then
            echo "### Build Exitoso (Python)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "La imagen Docker se construyo correctamente. Puedes proceder a:" >> $GITHUB_STEP_SUMMARY
            echo "1. Ejecutar \`deploy-staging.yml\` para construir y publicar la imagen" >> $GITHUB_STEP_SUMMARY
            echo "2. Configurar deployment scripts para staging/production" >> $GITHUB_STEP_SUMMARY
            echo "build_successful=true" >> $GITHUB_OUTPUT
          else
            echo "### Build Fallo (Python)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Acciones recomendadas:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Revisa los logs del job \`build-docker-python\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Verifica que el Dockerfile existe y esta bien formado" >> $GITHUB_STEP_SUMMARY
            echo "3. Asegurate de que \`pyproject.toml\` tiene todas las dependencias" >> $GITHUB_STEP_SUMMARY
            echo "4. Revisa los errores de build en los steps anteriores" >> $GITHUB_STEP_SUMMARY
            echo "build_successful=false" >> $GITHUB_OUTPUT
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Nota:** Esta imagen NO fue publicada a ningun registry. Es solo una prueba local." >> $GITHUB_STEP_SUMMARY
